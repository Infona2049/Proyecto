{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Validación de Correo</title>
  <link rel="stylesheet" href="{% static 'core/css/olvido_contraseña.css' %}">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
  <link rel="icon" href="{% static 'img/favicon.png.png' %}" type="image/png">
  <div class="top-bar">
    <div class="left-side">
      <a href="{% url 'visualizacion_cliente' %}">
        <img src="{% static 'img/Logo azul sin fondo.png' %}" alt="EcoFact Logo" class="logo1" />
        <img src="{% static 'img/logo empresa.png' %}" alt="Empresa logo " class="logo2" />
      </a>
    </div>
  </div>

  <header>
    <nav class="menu">
    </nav>
  </header>

  <div class="container">

    <!-- Sección correo (oculta por defecto) -->
    <div id="correo" class="hidden">
      <h2>Recuperar contraseña</h2>
      <p class="small">Ingresa el correo asociado a tu cuenta.</p>
      <input id="correo-input" type="email" placeholder="Ingresa tu correo">
      <div id="correo-error" class="message-error hidden"></div>
      <button onclick="enviarCodigo(this)">Enviar código</button>
    </div>

    <!-- Sección código (visible por defecto para coincidir con olvido_contraseña) -->
    <div id="codigo">
      <h2>Verifica tu correo</h2>
      <p class="small">Introduce el código que llegó a tu correo.</p>
      <input id="codigo-input" type="text" placeholder="Ingresa el código de 6 dígitos" maxlength="6">
      <div id="codigo-error" class="message-error hidden"></div>
      <button onclick="verificarCodigo(this)">Verificar código</button>
      <a id="reenviar-codigo" class="resend-link" onclick="reenviarCodigo()">Reenviar código</a>
      <button class="secondary" type="button" onclick="irDashboard()">Volver</button>
    </div>


    <!-- Sección de éxito para verificación de correo -->
    <div id="success_email" class="hidden">
      <h2>Correo verificado</h2>
      <p class="small">Tu correo ha sido verificado correctamente.</p>
      <div class="message-success">
        <span class="check">✓</span>
        <span>Gracias. Ya puedes iniciar sesión.</span>
      </div>
      <button onclick="irLogin()">Ir al inicio de sesión</button>
    </div>

  </div>

  <footer>
    <div class="footer-bar">
      <div class="footer-item">
        <img src="{% static 'img/mensaje.png' %}" alt="Correo">
        Ecofactproyect@gmail.com
      </div>
      <div class="footer-item">
        <img src="{% static 'img/llamada-telefonica.png' %}" alt="Teléfono">
        333-333-333
      </div>
    </div>
    <div class="footer-bottom">@2025-ECOFACT</div>
  </footer>

  <script src="{% static 'core/js/validacion_common.js' %}"></script>
  <script src="{% static 'core/js/validacion_correo.js' %}"></script>
  <script>
    function irDashboard(){
      // Intentar cancelar cualquier registro pendiente creado en esta sesión antes de redirigir.
      try {
        fetch("{% url 'cancelar_pending_registration' %}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({})
        }).catch(e => console.warn('No se pudo cancelar registro pendiente:', e)).finally(() => {
          // Si estamos en el flujo de registro, siempre ir a login después de cancelar
          {% if is_registration %}
            window.location.href = "{% url 'login' %}";
          {% else %}
            // Redirigir según si está autenticado y su rol
            {% if is_authenticated %}
              {% if user_role == 'admin' %}
                window.location.href = "{% url 'visualizacion_admin' %}";
              {% elif user_role == 'vendedor' %}
                window.location.href = "{% url 'visualizacion_vendedor' %}";
              {% else %}
                window.location.href = "{% url 'visualizacion_cliente' %}";
              {% endif %}
            {% else %}
              window.location.href = "{% url 'login' %}";
            {% endif %}
          {% endif %}
        });
      } catch (e) {
        {% if is_authenticated %}
          {% if user_role == 'admin' %}
            window.location.href = "{% url 'visualizacion_admin' %}";
          {% elif user_role == 'vendedor' %}
            window.location.href = "{% url 'visualizacion_vendedor' %}";
          {% else %}
            window.location.href = "{% url 'visualizacion_cliente' %}";
          {% endif %}
        {% else %}
          window.location.href = "{% url 'login' %}";
        {% endif %}
      }
    }
  </script>
  <script>
    // Si llegamos con #foto, mostrar esa pantalla al cargar.
    // Además, si el servidor indicó envío automático (auto_send), arrancar el temporizador y asignar el email.
    document.addEventListener('DOMContentLoaded', function(){
      // Si el servidor indicó `auto_email`, mostrar la pantalla de verificación y arrancar temporizador.
      {% if auto_email %}
        try {
          emailGlobal = "{{ auto_email|escapejs }}";
          // Indicar si venimos del flujo de cambio de correo o de registro
          {% if is_email_change %}
            is_email_change_flow = true;
          {% elif is_registration %}
            is_registration_flow = true;
          {% endif %}
          mostrarPantalla('codigo');
          iniciarTemporizadorReenvio();
        } catch (e) {
          console.error('No se pudo iniciar temporizador automático:', e);
          {% if is_email_change %}
            is_email_change_flow = true;
          {% elif is_registration %}
            is_registration_flow = true;
          {% endif %}
          mostrarPantalla('codigo');
        }
      {% else %}
        // Mostrar la sección indicada por el hash o 'correo' por defecto
        const target = (location.hash || '').replace('#','');
        if(target && document.getElementById(target)){
          mostrarPantalla(target);
        } else {
          mostrarPantalla('correo');
        }
      {% endif %}
    });
  </script>
</body>
</html>
